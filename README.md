# rcgamestats

rcgamestats is a script set that uses the RoboCup soccer 2D simulator to execute a large number of matches in a distributed manner and aggregate the match results.

rcgamestats assumes that matches will be distributed and executed on dozens or more host machines.
The match results will then be compiled using a Google spreadsheet.

## Requirements

- Ubuntu 22.04 or later
- bash
- cpufrequtils
- inotifywait
- python3
  - oauth2client
  - gspread

For the master server:
```
sudo apt install inotify-tools
pip install oauth2client --ignore-installed six
pip install gspread --ignore-installed six
```

It is recommended that all remote hosts be in a state where they can execute the cpufreq-set command.
```
sudo apt instal cpufrequtils
```
Then, users will need to set permissions to run `sudo cpufreq-set` without a password.

## Setup the Google Spreadsheet

The following OAuth settings are required:

1. Access to Google Developers Console https://console.cloud.google.com/
1. Create your own project
1. "API and service" in the left side bar -> Google Sheets API -> Enabled
1. "Authentication" in the left metnu
1. "Create authentication information"
  1. Select "Service account" key (create service account if it does not exist)
  1. Select "Key" tab
  1. Add key -> Select "JSON"
  1. Save the generated JSON file

Then, prepare the spreadsheet for writing results.
You can find a template at https://docs.google.com/spreadsheets/d/1hC038thh1lHH31M6V_T9e-obGJwwGTLUV83oZF4MoCo/edit?usp=sharing

Share the spreadsheet to the e-mail address, written in the saved JSON file as "client_email".

## Setup the script

First, put the rcgamestats directory at the home directory on the master server.
Users also need to copy the JSON key file to the master server.
Then, users need to modify the following configuration files in rcgamestats according to the environment:
- config : Global variables for scripts.
- available-hosts.tmpl : The list of remote hosts for running matches.
- teamlist : The list of available teams.


### config

At least, users change the following variableas according to the environment:
- server : The host name of the master server
- doc_id: The ID of Google spreadsheet. The ID value can be found in your spreadsheet URL. For example, the astarisk part of `https://docs.google.com/spreadsheets/d/***********/edit` is the ID value of this document.
- key_file : The file path to the oauth key file.

- left_team_start_script : The absolute path to the start script of the left team.

If users put the rcgamestats directory at another location, please modify the path value in other variables.

### available-hosts.tmpl

This is the template file listed the remote host machines.
Users need to list the remote host names in this file.
The listed hosts are used to run each game.

When starting the scheduled matches, the new file `available-host` is created by copying this template file.
Then, rcgamestats refere and update `available-host` to manage the available remote host mashine.

### teamlist

This file lists the available teams with CSV manner:

    TEAMNAME,SYNCH_MODE_SUPPORT,TEAM_DIR_PATH

Each team directory has to contain `start.sh` to start the team.


## cpufreq settings

TBU

## How to run
1. Build your team binary.
1. `./sync.sh` to synchronize all data with remote hosts.
1. `./register_group.sh` to create a match list file for the given opponent.
1. `./all-hosts.sh ps ux` to confirm the running process on remote hosts.
1. `./run.sh` to start the scheduled matches.


`matchlist` file is automatically generated by `register_groups.sh`. 
This file contains the queue of scheduled matches.
The format is simple, so users may modify them manually.

`run.sh` can be executed as a background process.
But if ssh connection to the master server is lost, `run.sh` will be terminated.
In order to avoid such a situation, it is recommended to use `nohup``:
`
nohup ./run.sh &
`

### How to stop

- Remve `matchlist` file. Thenï¼Œ`run.sh` will be finished immediately.
- The running matches will continue till the end game. You can stop each game by killing rcssserver.
- if `~/running-sim??` exists, that means "sim??" is occupied by a match. If the file exists but a host has no running match, please remove `runnning-sim??` manually.

`~/rcgamestats.log` is an entire log file.
Logs will continue to be appended to this file.
Please delete it when it is no longer needed.


## Generated files during the running
- `~/running-XXXX` : If this file exists, a match is running on the host "XXXX". This file is generated at the home directory on the master server.
- `~/lock.rcgamestats` : The lock file on the master server.
- `~/lock.saver-rcgamestats` : The lock file on the master server.

## Scripts executed by users
- all-hosts.sh <command>
    - Execute given command on all remote hosts.
- sync.sh
    - Copy all data to all remote hosts.
- sync_one.sh [host name]
    - Copy all data to the given host.
- register_group.sh <opponent name> <# of match> [<group tag>]
    1. Generate match list and save them into the matchlist file.
	1. The group "Datatime(-<group tag>)-<opponent name>" is generated.
	1. New works sheet is addded to the Google spreadsheet.
- run.sh
    1. Create available-host from available-hosts.tmpl
	1. If no matchlist file, exit.
    1. Trye to start the game listed in the matchlist file.
	1. If no available remote host, wait vacancy.
	1. Try new game:
        - If an available host exists in available-hosts, start a new game and return to Step.2
		- If not availalbe remote host, wait vacancy.

## Scripts that are automatically called (Under the "scripts" directory)
- cpufreq-set-all.sh
- create_sheet.py
- remote_run_match.sh
- server_append_host.sh
- server_save_result.sh
- write_queued_result.py
- write_result.py
