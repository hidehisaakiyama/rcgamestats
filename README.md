# rcgamestats

## Requirements

- Ubuntu 22.04 or later
- bash
- python3
- inotifywait

```
sudo apt install inotify-tools
```

### Configuration for Google Spreadsheet

#### OAuth Settings

1. Access to Google Developers Console https://console.cloud.google.com/
1. Create your own project
1. "API and service" in the left side bar -> Google Sheets API -> Enabled
1. "Authentication" in the left metnu
1. "Create authentication information"
  1. Select "Service account" key (create service account if it does not exist)
  1. Select "Key" tab
  1. Add key -> Select "JSON"
  1. Save the generated JSON file

#### Spreadsheet settings

Share the spreadsheet to the e-mail address written in the saved JSON file as "client_email"

"id" is tha astarisk part of the spread sheet url https://docs.google.com/spreadsheets/d/***********/edit

### Install the requirements

```
sudo apt install python3-pip
sudo pip install --upgrade pip
sudo pip install --upgrade oauth2client --ignore-installed six
sudo pip install gspread --ignore-installed six
```

## How to run
1. Build your team binary.
1. run ```sync.sh``` to transfer all data to remote hosts.
1. run ```register_group.sh``` to create a match list file.
1. run ```./all-hosts.sh ps ux``` to confirm the running process on remote hosts.
1. run ```run.sh`` to start the registered matches.

run.sh can be executed as a background process.
If ssh connection to the host machine is broken, run.sh is terminated. It is recommended to use ```nohup``:
```
nohup ./run.sh &
```

### How to stop

- Remve ```matchlist``` file. Thenï¼Œrun.sh will be finished immediately.
- The running matches will continue till the end game. You can stop each game by killing rcssserver.
- if ```~/running-sim??``` exists, that means "sim??" is occupied. If a host has not running matche, please remove ```runnning-sim??`` manually.

## Configuration files
- config : Global variables for scripts. Edit contents according to your environment.
- available-hosts.tmpl : The list of available hosts.  Edit contents according to your environment.
- matchlist : The queue of scheduled matches. This file is automatically generated.
- teamlist : The list of available teams.

## Generated files
- ~/running-XXXX : A match is running on the host "XXXX", generated at the home directory on the master server.
- ~/lock.rcgamestats : The lock file on the master server.
- ~/lock.saver-rcgamestats : The lock file on the master server.

## Scripts invoked by users
- all-hosts.sh <command>
    - Execute given command on all remote hosts.
- sync.sh
    - Copy all data to all remote hosts.
- sync_one.sh [host name]
    - Copy all data to the given host.
- register_group.sh <opponent name> <# of match> [<group tag>]
    1. Generate match list and save them into the matchlist file.
	1. The group "Datatime(-<group tag>)-<opponent name>" is generated.
	1. New works sheet is addded to the Google spreadsheet.
- run.sh
    1. Create available-host from available-hosts.tmpl
	1. If no matchlist file, exit.
    1. Trye to start the game listed in the matchlist file.
	1. If no available remote host, wait vacancy.
	1. Try new game:
        - If an available host exists in available-hosts, start a new game and return to Step.2
		- If not availalbe remote host, wait vacancy.

## Other scripts (Under the "scripts" directory, these scripts are automatically called)
- cpufreq-set-all.sh
- create_sheet.py
- remote_run_match.sh
- server_append_host.sh
- server_save_result.sh
- write_queued_result.py
- write_result.py
